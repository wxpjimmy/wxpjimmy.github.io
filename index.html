<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="Jimmy&#39;s Harbor">
<meta property="og:url" content="http://www.wxpjimmy.com/index.html">
<meta property="og:site_name" content="Jimmy&#39;s Harbor">
<meta property="og:description" content="Be a better man!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jimmy&#39;s Harbor">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.wxpjimmy.com/"/>





  <title>Jimmy's Harbor</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jimmy's Harbor</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2017/10/30/如何打造优雅的Thrift RPC封装库 - Part2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/30/如何打造优雅的Thrift RPC封装库 - Part2/" itemprop="url">如何打造优雅的Thrift RPC封装库 - Part2</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-30T23:20:01+08:00">
                2017-10-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index">
                    <span itemprop="name">rpc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一篇我们介绍了如何一步步打造一个包含基础功能，支持服务注册、服务发现的Thrift RPC封装库，本文叙接上文，主要围绕以下几个方面来介绍：</p>
<ul>
<li>负载均衡</li>
<li>连接池管理</li>
<li>客户端代理封装V2</li>
<li>统一监控</li>
</ul>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>常用的负载均衡算法参见<a href="http://www.wxpjimmy.com/2015/10/30/%E5%B8%B8%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/" target="_blank" rel="external">常用负载均衡算法介绍</a><br>所谓负载均衡，说白了就是根据下游多台机器的负载情况来动态调整流量分配。一个好的负载均衡算法要考虑到以下几种情况：</p>
<ul>
<li>服务器异构，不同服务器处理能力不同</li>
<li>某一台或多台服务异常</li>
</ul>
<p>代码示例结构如下：<br><img src="/2017/10/30/如何打造优雅的Thrift%20RPC封装库%20-%20Part2/Snip20171030_3.png" alt="[负载均衡代码结构]" title="[负载均衡代码结构]"></p>
<p>我们定义负载均衡算法接口ILoadBalancer如下：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public interface ILoadBalancer &#123;</div><div class="line">    /**</div><div class="line">     * choose one server instance</div><div class="line">     * </div><div class="line">     * @param all  all available server instances</div><div class="line">     * @param blacklist  server<span class="built_in"> instance </span>can't be connected during one request</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    ServerInstance getServerInstance(<span class="class">List&lt;ServerInstance&gt; all, List&lt;ServerInstance&gt; blacklist);</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其他几个类（RoundRobinLoadBalancer/CoHashLoadBalancer/PredictiveLoadBalancer）都是具体实现，分别代表round-robin算法、一致性hash算法以及根据下游负载以及处理能力动态调整算法。</p>
<h2 id="连接池管理"><a href="#连接池管理" class="headerlink" title="连接池管理"></a>连接池管理</h2><p>目前应用的最普遍的连接池管理工具包是apache common pool，我们就选用最新的v2版本来作为我们的连接池管理工具。<br>具体maven依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>连接池管理代码结构如下：<br><img src="/2017/10/30/如何打造优雅的Thrift%20RPC封装库%20-%20Part2/Snip20171030_4.png" alt="[连接池管理代码结构]" title="[连接池管理代码结构]"><br>其中定义了两个接口IConnectionPool和IConnectionPoolFactory：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IConnectionPool</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function">V <span class="title">borrowObject</span><span class="params">(K key)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">returnObject</span><span class="params">(K key, V value)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">discardObject</span><span class="params">(K key, V value)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IConnectionPoolFactory</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * get a connection pool based on provided ifaceClazz </span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> ifaceClazz  (server class definition)</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function">IConnectionPool&lt;K,V&gt; <span class="title">getConnectionPool</span><span class="params">(Class&lt;?&gt; ifaceClazz)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ConnectionPoolConfig类提供了连接池的参数设置，这些参数都是Commons pool中指定的，我们选取了部分重要的参数开放给用户设定：<br><img src="/2017/10/30/如何打造优雅的Thrift%20RPC封装库%20-%20Part2/Snip20171030_7.png" alt="[连接池重要参数]" title="[连接池重要参数]"></p>
<p>ConnectionKey类是common pool连接池管理中每个连接对应的key，它主要包含三个字段：<br><img src="/2017/10/30/如何打造优雅的Thrift%20RPC封装库%20-%20Part2/Snip20171030_5.png" alt="[连接池管理key对象]" title="[连接池管理key对象]"></p>
<p>ThriftConnectionKeyedPooledObjectFactory 继承自common pool的BaseKeyedPooledObjectFactory类，key是ConnectionKey，返回的value是TServiceClient，这个类主要提供具体创建连接的方法实现，具体如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ThriftConnectionKeyedPooledObjectFactory</span> <span class="keyword">extends</span> <span class="title">BaseKeyedPooledObjectFactory&lt;ConnectionKey</span>, <span class="title">TServiceClient&gt;</span> </span>&#123;</div><div class="line"></div><div class="line">    public <span class="type">TServiceClient</span> create(<span class="type">ConnectionKey</span> key) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">        <span class="comment">//create client</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="type">TSocket</span> socket = <span class="keyword">new</span> <span class="type">TSocket</span>(key.getServerInstance().getIp(), key.getServerInstance().getPort(), key.getTimeout());</div><div class="line">            <span class="type">TTransport</span> transport = <span class="keyword">new</span> <span class="type">TFramedTransport</span>(socket);</div><div class="line">            transport.open();</div><div class="line">            <span class="type">TProtocol</span> protocol = <span class="keyword">new</span> <span class="type">TBinaryProtocol</span>(transport);</div><div class="line">            <span class="type">Constructor</span>&lt;?&gt; cons = key.getiClientClass().getConstructor(<span class="type">TProtocol</span>.<span class="keyword">class</span>);</div><div class="line">            <span class="type">TServiceClient</span> res = (<span class="type">TServiceClient</span>) cons.newInstance(protocol);</div><div class="line">            <span class="keyword">return</span> res;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="type">TTransportException</span> e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public <span class="type">PooledObject</span>&lt;<span class="type">TServiceClient</span>&gt; wrap(<span class="type">TServiceClient</span> value) &#123;</div><div class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DefaultPooledObject</span>&lt;<span class="type">TServiceClient</span>&gt;(value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ThriftConnectionPool是真正的Thrift连接池实现类，它依赖commons pool的对象池GenericKeyedObjectPool来管理连接，提供创建连接、归还连接、删除连接以及关闭连接池的功能。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">public class ThriftConnectionPool implements IConnectionPool&lt;ConnectionKey, TServiceClient&gt; &#123;</div><div class="line">    private static Logger logger = LoggerFactory.getLogger(ThriftConnectionPool.class);</div><div class="line"></div><div class="line">    private GenericKeyedObjectPool&lt;ConnectionKey, TServiceClient&gt; connectionPool;</div><div class="line">    private ConnectionPoolConfig config;</div><div class="line"></div><div class="line">    public ThriftConnectionPool(ConnectionPoolConfig config) &#123;</div><div class="line">        this.connectionPool = new GenericKeyedObjectPool&lt;ConnectionKey, TServiceClient&gt;(new ThriftConnectionKeyedPooledObjectFactory());</div><div class="line"></div><div class="line">        this.config = config;</div><div class="line">        this.connectionPool.setMaxTotal(config.getMaxTotal());</div><div class="line">        this.connectionPool.setMaxTotalPerKey(config.getMaxTotalPerKey());</div><div class="line">        this.connectionPool.setMaxIdlePerKey(config.getMaxIdlePerKey());</div><div class="line">        this.connectionPool.setBlockWhenExhausted(config.isBlockWhenExhausted());</div><div class="line">        this.connectionPool.setMaxWaitMillis(config.getMaxWaitTimeInMillis());</div><div class="line">        this.connectionPool.setTestOnBorrow(config.isTestOnBorrow());</div><div class="line">        this.connectionPool.setTestOnReturn(<span class="literal">true</span>);</div><div class="line">        this.connectionPool.setTimeBetweenEvictionRunsMillis(config.getTimeBetweenEvictionRunsMillis());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public TServiceClient borrowObject(ConnectionKey key) &#123;</div><div class="line">        TServiceClient<span class="built_in"> client </span>= <span class="literal">null</span>;</div><div class="line">        try &#123;</div><div class="line">           <span class="built_in"> client </span>= this.connectionPool.borrowObject(key);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            logger.<span class="builtin-name">error</span>(<span class="string">"borrow client with key=&#123;&#125; failed, Exception: &#123;&#125;"</span>, key, e);</div><div class="line">            return <span class="literal">null</span>;</div><div class="line">        &#125;</div><div class="line">        return client;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void returnObject(ConnectionKey key, TServiceClient client) &#123;</div><div class="line">        this.connectionPool.returnObject(key, client);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void discardObject(ConnectionKey key, TServiceClient value) &#123;</div><div class="line">        try &#123;</div><div class="line">            this.connectionPool.invalidateObject(key, value);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">           logger.warn(<span class="string">"discard client failed! key=&#123;&#125;, Exception=&#123;&#125;"</span>, key, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void shutdown() &#123;</div><div class="line">        this.connectionPool.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DefaultConnectionPoolFactory和PerServiceConnectionPoolFactory是连接池工厂的具体实现，分别代表的是统一连接池管理和分服务不同连接池管理，后者主要是为了减少不同服务依赖之间的互相影响。</p>
<h2 id="客户端代理封装V2"><a href="#客户端代理封装V2" class="headerlink" title="客户端代理封装V2"></a>客户端代理封装V2</h2><p>好了，前面分别介绍了负载均衡和连接池管理，那么我们是如何将这些功能串起来的呢？   </p>
<p>我们先来回忆下第一篇中我们介绍的最简单封装，那种情况下我们是直接创建好了服务的Client对象直接返还给使用者，使用者直接使用这个Client来发起调用，逻辑很简单，也很好理解；但是当我们加入连接池的时候情况就不一样了，有了连接池，我们不仅要创建好Client，这个Client还应该是可以重用的，那么这种情况下如果我们只是简单提供给用户返还Client对象的方法就很容易出问题，你永远不要去猜测用户的使用习惯，最好的方法就是我们提供封装库来统一管理连接的创建/借用/归还/关闭。</p>
<p>那么我们该怎么做呢？</p>
<p>很显然，前一篇介绍的方法在这里很难再继续走下去，我们需要换个思路，如果我们来管理连接，那么就意味着用户是不需要关心具体调用使用的是哪个Client，只要我们保证在用户发起调用的时候能正确找到一个可用的连接，发起调用，调用成功后归还连接、调用失败关闭连接就好了。这里Java的代理机制就派上用场了，我们可以创建一个代理类来代理Client类，所有细节都封装在这个代理类中（具体Java代理的机制我们这里就不展开细说了，不熟悉的同学可以去baidu/google一下）。我们返还给客户端的实际上是这个代理类，因为这个代理类实现了跟Client对象完全一样的接口，对使用者来说是感受不到差别的。</p>
<p>我们看下代码结构：<br><img src="/2017/10/30/如何打造优雅的Thrift%20RPC封装库%20-%20Part2/Snip20171030_8.png" alt="[客户端代理V2代码结构]" title="[客户端代理V2代码结构]"></p>
<p>ClientProxyConfigFactory和ClientProxyV1是第一篇中我们介绍的封装，后者这里只是改了个名字。<br>ServiceProxy还是第一篇中介绍的封装，这里没有做任何改动（后续改进会单独讲）。</p>
<p>我们重点看一下ThriftClientConfig、ThriftClientFactory以及ThriftClientProxy三个类：</p>
<ul>
<li>ThriftClientConfig是客户端配置类，可以用它指定要使用的LoadBalancer、ConnectionPoolFactory、ServiceDiscovery、timeout等配置；</li>
<li>ThriftClientProxy是一个实现了InvocationHandler的代理类，他主要负责拦截用户发起的调用，根据要调用的服务找到一个可用的连接，然后通过反射发起调用，同时负责连接生命周期的维护；</li>
<li>ThriftClientFactory是提供给用户使用的接口。</li>
</ul>
<p>具体看下ThriftClientProxy类的实现：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">class ThriftClientProxy implements InvocationHandler &#123;</div><div class="line">    private Class&lt;?&gt; ifaceClass;</div><div class="line">    private Class&lt;?&gt; iclientClass;</div><div class="line">    private ThriftClientConfig config;</div><div class="line">    private IConnectionPool&lt;ConnectionKey, TServiceClient&gt; connectionPool;</div><div class="line">    private ServiceDiscovery serviceDiscovery;</div><div class="line"></div><div class="line">    public ThriftClientProxy(Class&lt;?&gt; ifaceClass, ThriftClientConfig config) &#123;</div><div class="line">        this.ifaceClass = ifaceClass;</div><div class="line">        this.config = config;</div><div class="line">        this.iclientClass = getIClientClass(ifaceClass);</div><div class="line">        this.connectionPool = config.getConnectionPoolFactory().getConnectionPool(ifaceClass);</div><div class="line"></div><div class="line">        serviceDiscovery = config.getServiceDiscovery();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</div><div class="line">        IConfig properties = config.getConfigProvider().getConfig(ifaceClass);</div><div class="line">        List&lt;ServerInstance&gt; invalidInstances = new ArrayList&lt;ServerInstance&gt;();</div><div class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</div><div class="line">            List&lt;ServerInstance&gt; serverInstances = serviceDiscovery.discoverService(ifaceClass);</div><div class="line">            String loadbalancer = properties.getProperty(Constants.RPC_LOADBALANCER, <span class="literal">null</span>);</div><div class="line">            ILoadBalancer loadBalancer = getLoadBalancer(loadbalancer);</div><div class="line">            ServerInstance<span class="built_in"> instance </span>= loadBalancer.getServerInstance(serverInstances, invalidInstances);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</div><div class="line">               throw new RuntimeException(<span class="string">"Can't find a valid server instance!"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            ConnectionKey connectionKey = new ConnectionKey(iclientClass, instance, config.getTimeout());</div><div class="line">            TServiceClient<span class="built_in"> client </span>= this.connectionPool.borrowObject(connectionKey);</div><div class="line">            <span class="keyword">if</span> (client == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (config.isFailFast()) &#123;</div><div class="line">                    throw new RuntimeException(<span class="string">"Can't borrow client from server: "</span> + instance);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    invalidInstances.<span class="builtin-name">add</span>(instance);</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            boolean exceptionOccurred = <span class="literal">false</span>;</div><div class="line">            try &#123;</div><div class="line">                return method.invoke(client, args);</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                exceptionOccurred = <span class="literal">true</span>;</div><div class="line">                this.connectionPool.discardObject(connectionKey, client);</div><div class="line">                <span class="keyword">if</span> (config.isFailFast()) &#123;</div><div class="line">                    throw new RuntimeException(e);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    invalidInstances.<span class="builtin-name">add</span>(instance);</div><div class="line">                    continue;</div><div class="line">                &#125;</div><div class="line">            &#125; finally &#123;</div><div class="line">                <span class="keyword">if</span> (!exceptionOccurred) &#123;</div><div class="line">                    this.connectionPool.returnObject(connectionKey, client);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所有重要的逻辑都是invoke方法中，它支持两种模式：retry-until-succeed以及fail-fast。前者是当调用失败的时候会将当前的服务节点标记为不可用，然后重新选取一个节点发起调用直到成功为止；后者是一旦有失败立即终止，更适合于latency比较敏感的服务，比如广告。</p>
<p>我们再看下具体逻辑，首先通过serverdiscovery找到可用的所有节点，然后从中根据指定的Loadbalancer算法选取一个节点，接下来从连接池中借用/创建一个该节点对应的连接，并通过反射直接发起调用，调用成功则归还连接并返回结果；如果失败则关闭当前连接，并根据指定的模式来决定是否重试。</p>
<p>我们可以看到，这种模式非常灵活，所有服务发现、节点选取、连接池管理的逻辑都隐藏在代理类中，用户使用的时候只需要简单的调用ThriftClientFactory获取连接代理即可，ThriftClientFactory实现如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThriftClientFactory</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T getClient(Class&lt;T&gt; ifaceClazz, ThriftClientConfig config) &#123;</div><div class="line">        ThriftClientProxy proxy = <span class="keyword">new</span> <span class="type">ThriftClientProxy</span>(ifaceClazz, config);</div><div class="line"></div><div class="line">        T clientProxy = (T) Proxy.<span class="keyword">new</span><span class="type">ProxyInstance</span>(ifaceClazz.getClassLoader(),</div><div class="line">                <span class="keyword">new</span> <span class="type">Class</span>&lt;?&gt;[]&#123;ifaceClazz, TServiceClient.class&#125;, proxy);</div><div class="line">        <span class="keyword">return</span> clientProxy;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是客户端使用的一个示例：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">V2Demo</span>(<span class="params"></span>) throws TException </span>&#123;</div><div class="line">   ThriftClientConfig clientConfig = <span class="keyword">new</span> ThriftClientConfig(<span class="literal">true</span>);</div><div class="line">   clientConfig.setConfigProvider(<span class="keyword">new</span> ZookeeperConfigProvider());</div><div class="line"></div><div class="line">   Calculator.Iface ifaceClient = ThriftClientFactory.getClient(Calculator.Iface.class, clientConfig);</div><div class="line">   <span class="keyword">if</span> (ifaceClient != <span class="literal">null</span>) &#123;</div><div class="line">       ifaceClient.ping();</div><div class="line">       <span class="keyword">int</span> result = ifaceClient.<span class="keyword">add</span>(<span class="number">100</span>, <span class="number">50</span>);</div><div class="line">       System.<span class="keyword">out</span>.println(<span class="string">"100 + 50 = "</span> + result);</div><div class="line"></div><div class="line">       ifaceClient.ping();</div><div class="line">       ifaceClient.ping();</div><div class="line">       ifaceClient.ping();</div><div class="line"></div><div class="line">       result = ifaceClient.<span class="keyword">add</span>(<span class="number">100</span>, <span class="number">80</span>);</div><div class="line">       System.<span class="keyword">out</span>.println(<span class="string">"100 + 80 = "</span> + result);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       System.<span class="keyword">out</span>.println(<span class="string">"create client failed!"</span>);</div><div class="line">   &#125;</div><div class="line">   ifaceClient.zip();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="统一监控"><a href="#统一监控" class="headerlink" title="统一监控"></a>统一监控</h2><p>其实有了前面的代理，统一监控就非常容易实现了，我们直接在代理类中添加监控就好，可以细分到service和method级别，添加qps、latency、超时等指标的监控，这里就不再具体展示了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文从如何更好的进行负载均衡和连接池管理出发，引出对前一篇基本封装的改进完善，通过引入java代理机制，使得实现更优美，功能更灵活，也更容易支持客户端封装的统一监控。下一篇我们会介绍在V2基础上如何支持熔断、降级和限流，敬请期待。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2017/10/22/如何打造优雅的Thrift RPC封装库 - Part1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/22/如何打造优雅的Thrift RPC封装库 - Part1/" itemprop="url">如何打造优雅的Thrift RPC封装库 - Part 1</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-22T22:00:01+08:00">
                2017-10-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/rpc/" itemprop="url" rel="index">
                    <span itemprop="name">rpc</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本系列文章我们重点对Thrift RPC封装库进行介绍，计划分成几部分来讲：</p>
<pre><code>* 一个简易版本的通用Thrift RPC库封装，支持服务注册、服务发现。
* Thrift RPC熔断、降级、限流
* Thrift RPC异步化（swift）
</code></pre><p>这篇主要讲第一部分。</p>
<h2 id="Thrift-RPC简介"><a href="#Thrift-RPC简介" class="headerlink" title="Thrift RPC简介"></a>Thrift RPC简介</h2><p>Thrift 是Facebook 开源的提供跨语言支持的服务框架，一般在业务开发中会被用于以下两种场景：</p>
<ul>
<li>结构化对象序列化，这个主要得益于Thrift提供的完善的序列化/反序列化机制，可以很好的应用于结构化数据存储（结合Kafka、Scribe、Hive等）</li>
<li>RPC服务框架，Thrift RPC相比Restful API的好处主要是结构化+bianry data传输效率更高，缺点是表达性不如Restful API直白，一般用于企业内部服务之间的通信。   </li>
</ul>
<p>具体介绍Thrift的概念和文档已经很多了，这里就不详细展开了，感兴趣的同学可以移步<a href="https://thrift.apache.org/" target="_blank" rel="external">Thrift 官网</a>了解详情。</p>
<h2 id="Thrift-RPC调用"><a href="#Thrift-RPC调用" class="headerlink" title="Thrift RPC调用"></a>Thrift RPC调用</h2><p>首先，我们先看一个正常Thrift RPC调用的例子。我们首先定义一个thrift 服务描述文件Calculator.thrift</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">namespace java tutorial</div><div class="line"></div><div class="line">service Calculator &#123;</div><div class="line">    void ping(),</div><div class="line">    i32 <span class="builtin-name">add</span>(1:i32 num1, 2:i32 num2),</div><div class="line">    oneway void zip()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过thrift命令</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">thrift --gen <span class="tag">&lt;<span class="name">language</span>&gt;</span> <span class="tag">&lt;<span class="name">Thrift</span> <span class="attr">filename</span>&gt;</span></div></pre></td></tr></table></figure>
<p>项目中引用生成的java代码 （推荐使用maven thrift plugin插件），启动server代码如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Calculator.Processor processor = <span class="keyword">new</span> <span class="type">Calculator</span>.Processor(<span class="keyword">new</span> <span class="type">CalculatorServiceImpl</span>());</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  TServerTransport serverTransport = <span class="keyword">new</span> <span class="type">TServerSocket</span>(<span class="number">9090</span>);</div><div class="line">  TServer server = <span class="keyword">new</span> <span class="type">TSimpleServer</span>(processor, serverTransport);</div><div class="line"></div><div class="line">  <span class="comment">// Use this for a multithreaded server</span></div><div class="line">  <span class="comment">// TServer server = new TThreadPoolServer(new TThreadPoolServer.Args(serverTransport).processor(processor));</span></div><div class="line"></div><div class="line">  System.out.println(<span class="string">"Starting the simple server..."</span>);</div><div class="line">  server.serve();</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">  e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Server thrift提供了多种类型，这里demo只用了最简单的TSimpleServer。<br>我们看下启动过程：</p>
<ul>
<li>首先，使用生成代码中的Processor类，构造使用的参数是我们提供的服务实现CalculatorServiceImpl对象。 </li>
<li>创建TServerTransport，服务绑定的端口是9090</li>
<li>使用Processor和serverTransport创建TSimpleServer，并通过server.serve启动服务。</li>
</ul>
<p>接下来我们看下client 调用 server端代码：</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="type">TTransport</span> transport;</div><div class="line">    transport = <span class="function"><span class="keyword">new</span> <span class="title">TSocket</span>("localhost", <span class="number">9090</span>);</span></div><div class="line"><span class="function">    <span class="title">transport</span>.<span class="title">open</span>();</span></div><div class="line"><span class="function">    <span class="title">TProtocol</span> <span class="title">protocol</span> = <span class="title">new</span> <span class="title">TBinaryProtocol</span>(transport);</span></div><div class="line"><span class="function">    <span class="title">Calculator</span>.<span class="title">Client</span> <span class="title">client</span> = <span class="title">new</span> <span class="title">Calculator</span>.<span class="title">Client</span>(protocol);</span></div><div class="line"><span class="function">    <span class="title">client</span>.<span class="title">ping</span>();</span></div><div class="line"><span class="function">    <span class="title">int</span> <span class="title">result</span> = <span class="title">client</span>.<span class="title">add</span>(<span class="number">100</span>, <span class="number">20</span>);</span></div><div class="line"><span class="function">    <span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span>(result);</span></div><div class="line"><span class="function">&#125; <span class="title">catch</span> (<span class="type">TTransportException</span> e) &#123;</span></div><div class="line"><span class="function">    <span class="title">e</span>.<span class="title">printStackTrace</span>();</span></div><div class="line"><span class="function">&#125; <span class="title">catch</span> (<span class="type">TException</span> e) &#123;</span></div><div class="line"><span class="function">    <span class="title">e</span>.<span class="title">printStackTrace</span>();</span></div><div class="line"><span class="function">&#125;</span></div></pre></td></tr></table></figure>
<p>可以看到，客户端指定传输协议，通过socket连接到本机9090端口；接下来指定编码协议是使用二进制编码TBinaryProtocol；最后构造Calculator Client对象，并通过创建的Client对象调用远程服务接口进行操作。</p>
<h2 id="为什么需要封装通用的Thrift-RPC库"><a href="#为什么需要封装通用的Thrift-RPC库" class="headerlink" title="为什么需要封装通用的Thrift RPC库"></a>为什么需要封装通用的Thrift RPC库</h2><p>刚才我们描述了一个最简单的thrift服务启动和客户端调用流程。如果我们只有这么一个服务，这种方式可以work得很happy。而实际上往往没有这么简单，每次都需要这么一段代码来创建一个客户端，并且如果下游服务有多台机器，我还要考虑如何管理链接、如何进行负载均衡，诸如此类事情如果让每个服务定义方/使用方自己去做，无疑代价是巨大的，后续的维护升级都不是一件容易的事情，这也是为什么通常我们都需要封装一个通用的Thrift RPC库的最直接的原因之一。</p>
<p>那么我们该如何来定义通用的Thrift RPC库呢？</p>
<h2 id="最简单的Thrift-RPC封装"><a href="#最简单的Thrift-RPC封装" class="headerlink" title="最简单的Thrift RPC封装"></a>最简单的Thrift RPC封装</h2><p>我们再来回顾下刚才的代码示例，首先为了通用，我们需要约束序列化的机制（比如都使用Bianry），统一了序列化之后，我们先看下服务端，在服务端我们要做的其实很简单，只需要框架能够根据提供的服务名（这里比如Calculator.Iface)能创建对应的TProcessor就可以。这个可以通过反射来完成，因为Thrift自动生成的stub代码编译后，Processor class文件都是以<service>$Processor来命名的。示例代码如下：</service></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; TServer getServer(Class&lt;T&gt; clazz, T serviceImplInstance, int port) &#123;</div><div class="line">   <span class="comment">//get Processor class name</span></div><div class="line">   <span class="built_in">String</span> simpleName = clazz.getName();</div><div class="line">   <span class="built_in">String</span> name = simpleName;</div><div class="line">   <span class="keyword">if</span> (simpleName.endsWith(<span class="string">"$Iface"</span>)) &#123;</div><div class="line">       name = simpleName.substring(<span class="number">0</span>, simpleName.indexOf(<span class="string">"$Iface"</span>));</div><div class="line">   &#125;</div><div class="line">   name = name + <span class="string">"$Processor"</span>;</div><div class="line">   <span class="comment">//verify processpr class exist</span></div><div class="line">   Class&lt;?&gt; processorClass;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       processorClass = Class.forName(name);</div><div class="line">   &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">       System.out.println(<span class="string">"Class not found: "</span> + name);</div><div class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//create server</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       TServerTransport serverTransport = <span class="keyword">new</span> TServerSocket(port);</div><div class="line">       Constructor&lt;?&gt; <span class="keyword">constructor</span> = processorClass.getConstructor(<span class="params">clazz</span>);</div><div class="line">       TProcessor tProcessor = (<span class="params">TProcessor</span>) <span class="keyword">constructor</span>.newInstance(<span class="params">serviceImplInstance</span>);</div><div class="line">       TServer server = new TSimpleServer(<span class="params">tProcessor, serverTransport</span>);</div><div class="line">       return server;</div><div class="line">   &#125; catch (<span class="params">TTransportException e</span>) &#123;</div><div class="line">       e.printStackTrace(<span class="params"></span>);</div><div class="line">   &#125; catch (<span class="params">Exception e</span>) &#123;</div><div class="line">       e.printStackTrace();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>启动服务代码如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">TServer<span class="built_in"> server </span>= getServer(Calculator.Iface.class, new CalculatorServiceImpl(), 9090);</div><div class="line"><span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;</div><div class="line">    System.out.println(<span class="string">"Starting the simple server..."</span>);</div><div class="line">    server.serve();</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    System.out.println(<span class="string">"Get server failed!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端测也类似，我们可以看到，客户端需要构建Client对象，而所有服务的Client对象实际上都实现了TServerClient和对应的Iface接口：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public static class<span class="built_in"> Client </span>implements TServiceClient, Iface &#123;</div></pre></td></tr></table></figure>
<p>Client的构造函数也是固定的使用TProtocol，所以基于这些信息，我们可以通过反射创建出TServerClient，然后返回给客户端的时候转为对应的Iface类型，这样客户端就可以通过简单得提供Iface class来获取相应的客户端操作对象，并进行后续的调用处理。代码示例如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; T getClient(Class&lt;T&gt; clazz, <span class="keyword">String</span> host, int port) &#123;</div><div class="line">   <span class="comment">//get client class name</span></div><div class="line">   <span class="keyword">String</span> simpleName = clazz.getName();</div><div class="line">   <span class="keyword">String</span> name = simpleName;</div><div class="line">   <span class="keyword">if</span>(simpleName.endsWith(<span class="string">"$Iface"</span>)) &#123;</div><div class="line">       name = simpleName.substring(<span class="number">0</span>, simpleName.indexOf(<span class="string">"$Iface"</span>));</div><div class="line">   &#125;</div><div class="line">   name  = name + <span class="string">"$Client"</span>;</div><div class="line">   <span class="comment">//verify client class exist</span></div><div class="line">   Class&lt;?&gt; clientClass;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       clientClass = Class.forName(name);</div><div class="line">   &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">       System.out.println(<span class="string">"Class not found: "</span> + name);</div><div class="line">       <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//create client</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">       TTransport transport;</div><div class="line">       transport = <span class="keyword">new</span> <span class="type">TSocket</span>(host, port);</div><div class="line">       transport.open();</div><div class="line">       TProtocol protocol = <span class="keyword">new</span> <span class="type">TBinaryProtocol</span>(transport);</div><div class="line">       Constructor&lt;?&gt; cons = clientClass.getConstructor(TProtocol.class);</div><div class="line">       T res = (T) cons.<span class="keyword">new</span><span class="type">Instance</span>(protocol);</div><div class="line">       <span class="keyword">return</span> res;</div><div class="line">   &#125; <span class="keyword">catch</span> (TTransportException e) &#123;</div><div class="line">       e.printStackTrace();</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">       e.printStackTrace();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用方式如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Calculator.Iface ifaceClient = getClient(Calculator.Iface.class, <span class="string">"localhost"</span>, <span class="number">9090</span>);</div><div class="line"><span class="keyword">if</span> (ifaceClient != <span class="literal">null</span>) &#123;</div><div class="line">  ifaceClient.ping();</div><div class="line">  <span class="keyword">int</span> result = ifaceClient.<span class="keyword">add</span>(<span class="number">100</span>, <span class="number">20</span>);</div><div class="line">  System.<span class="keyword">out</span>.println(<span class="string">"100 + 20 = "</span> + result);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  System.<span class="keyword">out</span>.println(<span class="string">"create client failed!"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此我们已经可以很简单的构造一个通用服务启动代理和客户端代理来进行RPC调用了。</p>
<h2 id="升级版Thrift-RPC代理-–-服务注册、服务发现"><a href="#升级版Thrift-RPC代理-–-服务注册、服务发现" class="headerlink" title="升级版Thrift RPC代理 – 服务注册、服务发现"></a>升级版Thrift RPC代理 – 服务注册、服务发现</h2><p>前面我们已经介绍了最简单的服务和客户端封装，我们可以看到调用服务的地址都是固定的某台机器，实际线上使用过程中，下游服务往往都是会部署多台，为了简化服务提供方和服务使用方的工作，我们需要在Thrift RPC框架中支持服务注册和服务发现，下面我们就分别介绍一下我们该如何在刚才封装的基础上来支持服务注册和服务发现。</p>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>目前通用的服务注册中心有Zookeeper、Etcd、Eureka、Consul等，这里我们选用Zookeeper作为demo（其他流程类似，感兴趣可以自行实现）。<br>服务注册的目的是在服务器启动的时候能够将自己注册到Zookeeper上，在服务关闭的时候将自己从zk的注册列表中移除。我们约定服务在zk注册的形式如下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta-keyword">/registry/</span><span class="params">&lt;service full name&gt;</span>/Nodes/<span class="params">&lt;ip&gt;</span>:<span class="params">&lt;port&gt;</span></div></pre></td></tr></table></figure>
<p>我们定义服务注册接口ServiceRegistry如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public<span class="built_in"> interface </span>ServerRegistry &#123;</div><div class="line">    void register() throws Exception;</div><div class="line">    void unregister() throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基于CuratorFramework实现的ZookeeperServeRegistry如下：</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperServerRegistry</span> <span class="keyword">implements</span> <span class="title">ServerRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CuratorFramework <span class="keyword">client</span>;</div><div class="line">    <span class="keyword">private</span> String zkPathPattern = <span class="string">"/registry/%s/Nodes/%s:%d"</span>;</div><div class="line">    <span class="keyword">private</span> String zkPath;</div><div class="line">    <span class="keyword">public</span> ZookeeperServerRegistry(String zkhost, <span class="keyword">int</span> zkPort, <span class="keyword">int</span> serverPort, String serverName) &#123;</div><div class="line">        <span class="keyword">client</span> = CuratorFrameworkFactory.newClient(</div><div class="line">                zkhost + <span class="string">":"</span> + zkPort,</div><div class="line">                <span class="keyword">new</span> RetryNTimes(<span class="number">10</span>, <span class="number">5000</span>)</div><div class="line">        );</div><div class="line">        <span class="keyword">client</span>.start();</div><div class="line">        System.out.println(<span class="string">"zk client start successfully!"</span>);</div><div class="line">        String ip = Utils.getIp();</div><div class="line"></div><div class="line">        zkPath = String.format(zkPathPattern, serverName, ip, serverPort);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> register() throws Exception &#123;</div><div class="line">        Stat stat = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stat = <span class="keyword">client</span>.checkExists().creatingParentContainersIfNeeded().forPath(zkPath);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span>(stat == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">client</span>.create().creatingParentsIfNeeded().forPath(zkPath);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> unregister() throws Exception &#123;</div><div class="line">        Stat stat = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            stat = <span class="keyword">client</span>.checkExists().creatingParentContainersIfNeeded().forPath(zkPath);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (stat != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">client</span>.delete().deletingChildrenIfNeeded().forPath(zkPath);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面我们看下服务启动通用注册流程：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> startServer(<span class="keyword">Class</span>&lt;T&gt; ifaceClass, T serverImpleInstance, <span class="keyword">int</span> serverPort) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   <span class="keyword">final</span> TServer server = getServer(ifaceClass, serverImpleInstance, serverPort);</div><div class="line">   <span class="keyword">if</span> (server != <span class="keyword">null</span>) &#123;</div><div class="line">       System.out.<span class="keyword">println</span>(<span class="string">"Starting the simple server..."</span>);</div><div class="line">       Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</div><div class="line">               server.serve();</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">       thread.start();</div><div class="line">       <span class="keyword">final</span> ZookeeperServerRegistry registry = <span class="keyword">new</span> ZookeeperServerRegistry(<span class="string">"127.0.0.1"</span>, <span class="number">2181</span>, <span class="number">9090</span>, getServerName(ifaceClass));</div><div class="line">       registry.register();</div><div class="line">       <span class="keyword">Runtime</span>.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">           <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   registry.unregister();</div><div class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                   e.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       System.out.<span class="keyword">println</span>(<span class="string">"Get server failed!"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此我们完成了基于Zookeeper的服务注册。</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>服务注册完成后，所有服务的使用者就不再需要自己去在代码里维护一个服务节点列表，直接从ZK获取就好，并且可以做到服务扩容/缩容的及时响应。<br>我们定义服务发现接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServiceDiscovery</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;ServerInstance&gt; <span class="title">discoverService</span><span class="params">(Class&lt;?&gt; ifaceClazz)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerInstance</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String ip;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerInstance</span><span class="params">(String ip, <span class="keyword">int</span> port)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.ip = ip;</div><div class="line">        <span class="keyword">this</span>.port = port;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIp</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> ip;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> port;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"ServerInstance&#123;"</span> +</div><div class="line">                <span class="string">"ip='"</span> + ip + <span class="string">'\''</span> +</div><div class="line">                <span class="string">", port="</span> + port +</div><div class="line">                <span class="string">'&#125;'</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样基于CuratorFramework实现ZookeeperServiceDiscovery：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperServiceDiscovery</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">ServiceDiscovery</span></span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> CuratorFramework client;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> zkPathPattern = <span class="string">"/registry/%s/Nodes"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">String</span> zkPath;</div><div class="line">    <span class="keyword">private</span> List&lt;ServerInstance&gt; serverInstances;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> ZookeeperServiceDiscovery(<span class="keyword">String</span> zkhost, int zkPort, Class&lt;?&gt; ifaceClass) &#123;</div><div class="line">        client = CuratorFrameworkFactory.<span class="keyword">new</span><span class="type">Client</span>(</div><div class="line">                zkhost + <span class="string">":"</span> + zkPort,</div><div class="line">                <span class="keyword">new</span> <span class="type">RetryNTimes</span>(<span class="number">10</span>, <span class="number">5000</span>)</div><div class="line">        );</div><div class="line">        client.start();</div><div class="line"></div><div class="line">        <span class="keyword">String</span> serverName = Utils.getServerName(ifaceClass);</div><div class="line">        zkPath = <span class="keyword">String</span>.format(zkPathPattern, serverName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> List&lt;ServerInstance&gt; discoverService(Class&lt;?&gt; ifaceClazz) &#123;</div><div class="line">        <span class="keyword">if</span> (serverInstances != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> serverInstances;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            List&lt;<span class="keyword">String</span>&gt; items = client.getChildren().usingWatcher(<span class="keyword">new</span> <span class="type">CuratorWatcher</span>() &#123;</div><div class="line">                <span class="keyword">public</span> void process(WatchedEvent watchedEvent) throws Exception &#123;</div><div class="line">                    <span class="keyword">if</span> (watchedEvent.getType() == Watcher.Event.EventType.NodeChildrenChanged) &#123;</div><div class="line">                        update();</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (watchedEvent.getType() == Watcher.Event.EventType.NodeDeleted) &#123;</div><div class="line">                        serverInstances = <span class="literal">null</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;).forPath(zkPath);</div><div class="line">            serverInstances = parseServer(items);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> serverInstances;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> void update() &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            List&lt;<span class="keyword">String</span>&gt; items = client.getChildren().forPath(zkPath);</div><div class="line">            serverInstances = parseServer(items);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;ServerInstance&gt; parseServer(List&lt;<span class="keyword">String</span>&gt; items) &#123;</div><div class="line">        <span class="keyword">if</span> (items == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">        &#125;</div><div class="line">        List&lt;ServerInstance&gt; servers = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;ServerInstance&gt;();</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">String</span> item: <span class="type">items</span>) &#123;</div><div class="line">            <span class="keyword">String</span>[] parts = StringUtils.split(item, <span class="string">":"</span>);</div><div class="line">            servers.add(<span class="keyword">new</span> <span class="type">ServerInstance</span>(parts[<span class="number">0</span>], Integer.valueOf(parts[<span class="number">1</span>])));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> servers;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端的封装更改如下：</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> &lt;T&gt; T getClient(Class&lt;T&gt; clazz) &#123;</div><div class="line">   ZookeeperServiceDiscovery serviceDiscovery = <span class="keyword">new</span> <span class="type">ZookeeperServiceDiscovery</span>(<span class="string">"127.0.0.1"</span>, <span class="number">2181</span>, clazz);</div><div class="line">   List&lt;ServerInstance&gt; serverInstances = serviceDiscovery.discoverService(clazz);</div><div class="line">   <span class="keyword">if</span> (serverInstances == <span class="literal">null</span> || serverInstances.isEmpty()) &#123;</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(<span class="string">"No server instance found!"</span>);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//here choose one endpoint, for demo we just take the first one</span></div><div class="line">   ServerInstance instance = serverInstances.<span class="keyword">get</span>(<span class="number">0</span>);</div><div class="line">   <span class="keyword">return</span> getClient(clazz, instance.getIp(), instance.getPort());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们就可以通过简单的指定服务定义的Iface类来获取到对应服务的客户端实例进行操作。</p>
<h2 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h2><p>本文主要介绍的是最简易版本的Thrift RPC通用封装，支持基于Zookeeper的服务注册、服务发现，还远远称不上是一个完备的RPC封装库，架子已经搭好，接下来的一篇会介绍如何对RPC封装进行通用的负载均衡、监控、熔断、降级、限流等功能的完善，敬请期待。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2016/09/04/grpc学习-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/04/grpc学习-1/" itemprop="url">GRPC系列－(1)： GRPC的历史以及设计理念</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-09-04T17:30:48+08:00">
                2016-09-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近听说GRPC 1.0发布了，这是google开源的一个rpc框架，本着“google出品，必属精品”的原则，决定来学习一下这个框架，看看它跟现有的一些框架相比有什么优缺点，第一篇先简单介绍一个grpc框架的由来以及设计理念。  </p>
<h2 id="GRPC-介绍"><a href="#GRPC-介绍" class="headerlink" title="GRPC 介绍"></a>GRPC 介绍</h2><p>GRPC是由google开源的一个高性能、跨语言的RPC框架，面向移动和HTTP/2设计。目前提供 C、Java 和 Go 语言版本，分别是：<a href="https://github.com/grpc/grpc" target="_blank" rel="external">grpc</a>, <a href="https://github.com/grpc/grpc-java" target="_blank" rel="external">grpc-java</a>, <a href="https://github.com/grpc/grpc-go" target="_blank" rel="external">grpc-go</a>. 其中 C 版本支持 C, C++, Node.js, Python, Ruby, Objective-C, PHP 和 C# 支持.<br>GRPC 基于 HTTP/2 标准设计，带来诸如双向流、流控、头部压缩、单 TCP连接上的多复用请求等特。这些特性使得其在移动设备上表现更好，更省电和节省空间占用。  </p>
<h2 id="GRPC-动机"><a href="#GRPC-动机" class="headerlink" title="GRPC 动机"></a>GRPC 动机</h2><p>十多年来，google一直使用一个叫做Stubby的通用RPC基础框架，用它来连接数据中心内和跨数据中心运行的大量微服务。google内部系统早就接受了如今越来越流行的微服务架构，拥有一个统一的、跨平台的RPC的基础框架，使得服务的首次发行在效率、安全性、可靠性和行为分析上得到全面提升，这是支撑这一时期谷歌快速增长的关键。﻿﻿<br>Stubby有许多非常棒的特性，然而，它没有基于任何标准，而且与google内部的基础框架耦合得太紧密以至于被认为不适合公开发布。随着SPDY、HTTP/2和QUIC的到来，许多类似特性在公共标准中出现，并提供了Stubby不支持的其它功能。很明显，是时候利用这些标准来重写Stubby，并将其适用性扩展到移动、物联网和云场景。﻿﻿而这就是GRPC在google诞生的动机。</p>
<h2 id="GRPC-设计理念"><a href="#GRPC-设计理念" class="headerlink" title="GRPC 设计理念"></a>GRPC 设计理念</h2><p>按照google自己官方说法，grpc的设计理念主要包含以下几方面：  </p>
<ul>
<li>服务而非对象、消息而非引用 —— 促进微服务的系统间粗粒度消息交互设计理念，同时避免分布式对象的陷阱和分布式计算的谬误。﻿  </li>
<li>普遍并且简单 —— 该基础框架应该在任何流行的开发平台上适用，并且易于被个人在自己的平台上构建。它在CPU和内存有限的设备上也应该切实可行。﻿  </li>
<li>免费并且开源 —— 所有人可免费使用基本特性。以友好的许可协议开源方式发布所有交付件。﻿  </li>
<li>互通性 —— 该数据传输协议(Wire Protocol)必须遵循普通互联网基础框架。﻿  </li>
<li>通用并且高性能 —— 该框架应该适用于绝大多数用例场景，相比针对特定用例的框架，该框架只会牺牲一点性能。﻿  </li>
<li>分层 —— 该框架的关键是必须能够独立演进。对数据传输格式(Wire Format)的修改不应该影响应用层。﻿  </li>
<li>负载无关的 —— 不同的服务需要使用不同的消息类型和编码，例如protocol buffers、JSON、XML和Thrift，协议上和实现上必须满足这样的诉求。类似地，对负载压缩的诉求也因应用场景和负载类型不同而不同，协议上应该支持可插拔的压缩机制。﻿  </li>
<li>流 —— 存储系统依赖于流和流控来传递大数据集。像语音转文本或股票代码等其它服务，依靠流表达时间相关的消息序列。﻿  </li>
<li>阻塞式和非阻塞式 —— 支持异步和同步处理在客户端和服务端间交互的消息序列。这是在某些平台上缩放和处理流的关键。﻿  </li>
<li>取消和超时 —— 有的操作可能会用时很长，客户端运行正常时，可以通过取消操作让服务端回收资源。当任务因果链被追踪时，取消可以级联。客户端可能会被告知调用超时，此时服务就可以根据客户端的需求来调整自己的行为。﻿</li>
<li>Lameducking —— 服务端必须支持优雅关闭，优雅关闭时拒绝新请求，但继续处理正在运行中的请求。﻿  </li>
<li>流控 —— 在客户端和服务端之间，计算能力和网络容量往往是不平衡的。流控可以更好的缓冲管理，以及保护系统免受来自异常活跃对端的拒绝服务(DOS)攻击。﻿  </li>
<li>可插拔 —— 数据传输协议(Wire Protocol)只是功能完备API基础框架的一部分。大型分布式系统需要安全、健康检查、负载均衡和故障恢复、监控、跟踪、日志等。实现上应该提供扩展点，以允许插入这些特性和默认实现。﻿  </li>
<li>API扩展 ——﻿ 可能的话，在服务间协作的扩展应该最好使用接口扩展，而不是协议扩展。这种类型的扩展可以包括健康检查、服务内省、负载监测和负载均衡分配。﻿  </li>
<li>元数据交换 —— 常见的横切关注点，如认证或跟踪，依赖数据交换，但这不是服务公共接口中的一部分。部署依赖于他们将这些特性以不同速度演进到服务暴露的个别API的能力。﻿  </li>
<li>标准化状态码 —— 客户端通常以有限的方式响应API调用返回的错误。应该限制状态代码名字空间，使得这些错误处理决定更清晰。如果需要更丰富的特定域的状态，可以使用元数据交换机制来提供。﻿﻿</li>
</ul>
<p>grpc的理念是很赞的！很多都是目前的rpc框架所不能满足的（比如thrift不支持异步调用），接下来会参考源代码提供的示例具体看下grpc的使用情况。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2016/08/21/Google-guice学习-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/21/Google-guice学习-1/" itemprop="url">Google guice学习(1)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-21T20:43:07+08:00">
                2016-08-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在研究DRUID，druid整个设计采用了Google的guice依赖注入框架，所以要想学习druid源代码，首先要弄明白guice框架是怎么回事。</p>
<h2 id="什么是GUICE"><a href="#什么是GUICE" class="headerlink" title="什么是GUICE"></a>什么是GUICE</h2><p>Guice是Google开发的一个轻量级，基于Java5（主要运用泛型与注释特性）的依赖注入框架(IOC)。Guice非常小而且快。Guice是类型安全的，它能够对构造函数，属性，方法（包含任意个参数的任意方法，而不仅仅是setter方法）进行注入。</p>
<p>guice还具有一些可选的特性比如：自定义scopes，传递依赖，静态属性注入，与Spring集成和AOP联盟方法注入等。一部分人认为，Guice可以完全替代spring, 因为对于DI组件框架来说, 性能是很重要的, guice比spring快十倍左右, 另外, 也是最重要的一点, 使用spring很容易写成service locator的风格, 而用guice, 你会很自然的形成DI风格.甚至说，guice简单超轻量级的DI框架效率是spring的1.6倍，Spring使用XML使用将类与类之间的关系隔离到xml中，由容器负责注入被调用的对象，而guice将类与类之间的关系隔离到Module中，声明何处需要注入，由容器根据Module里的描述，注入被调用的对象,使用Annotation使用支持自定义Annotation标注，对于相同的接口定义的对象引用，为它们标注上不同的自定义Annotation注释，就可以达到同一个类里边的同一个接口的引用，注射给不同的实现，在Module里用标注做区分，灵活性大大增加</p>
<h2 id="guice跟spring对比"><a href="#guice跟spring对比" class="headerlink" title="guice跟spring对比"></a>guice跟spring对比</h2><ul>
<li>使用XML<br>Spring 使用将类与类之间的关系隔离到xml中，由容器负责注入被调用的对象，因此叫做依赖注入。<br>Guice 不使用xml,将类与类之间的关系隔离到Module中，声名何处需要注入，由容器根据Module里的描述，注入被调用的对象。  </li>
<li>使用Annotation<br>Guice 使用，支持自定义Annotation标注  </li>
<li>运行效率<br>Spring 装载spring配置文件时，需解析xml，效率低，getBean效率也不高，不过使用环境不会涉及到getBean，只有生产环境的时候会用到getBean,在装载spring应用程序的时候，已经完成全部的注射，所以这个低效率的问题不是问题。<br>Guice 使用Annotation，cglib, 效率高与spring最明显的一个区别，spring是在装载spring配置文件的时候把该注入的地方都注入完，而Guice呢，则是在使用的时候去注射，运行效率和灵活性高。  </li>
<li>类耦合度<br>Spring 耦合度低，强调类非侵入，以外部化的方式处理依赖关系，类里边是很干净的，在配置文件里做文章，对类的依赖性极低。<br>Guice 高，代码级的标注，DI标记@inject侵入代码中，耦合到了类层面上来，何止侵入，简直侵略，代码耦合了过多guice的东西，大大背离了依赖注入的初衷，对于代码的可维护性，可读性均不利  </li>
<li>类编写时<br>Spring 需要编写xml，配置Bean，配置注入。<br>Guice 只需声明为@inject,等着被注入，最后在统一的Module里声明注入方式。  </li>
<li>仅支持IoC<br>Spring 否，spring目前已经涉猎很多部分。<br>Guice 是，目前仅仅是个DI容器。  </li>
<li>是否易于代码重构<br>Spring 统一的xml配置入口，更改容易。<br>Guice 配置工作是在Module里进行，和spring异曲同功  </li>
<li>支持多种注入方式<br>Spring 构造器，setter方法。<br>Guice Field,构造器，setter方法.  </li>
<li>灵活性<br>Guice 1.如果同一个接口定义的引用需要注入不同的实现，就要编写不同的Module，烦琐 2.动态注入，如果你想注射的一个实现，你还未知呢，怎么办呢，spring是没办法，事先在配置文件里写死的，而Guice就可以做到，就是说我想注射的这个对象我还不知道注射给谁呢，是在运行时才能得到的的这个接口的实现，所以这就大大提高了依赖注射的灵活性，动态注射。<br>与现有框架集成度<br>Spring 1.高，众多现有优秀的框架（如struts1.x等）均提供了spring的集成入口，而且spring已经不仅仅是依赖注入，包括众多方面。2. Spring也提供了对Hibernate等的集成，可大大简化开发难度。3.提供对于orm,rmi,webservice等等接口众多，体系庞大。<br>Guice 1.可以与现有框架集成，不过仅仅依靠一个效率稍高的DI，就想取代spring的地位，有点难度。  </li>
<li>配置复杂度<br>Spring 在xml中定位类与类之间的关系,难度低。<br>Guice 代码级定位类与类之间的关系,难度稍高。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/11/26/Linux常用命令之strace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/26/Linux常用命令之strace/" itemprop="url">Linux常用命令之strace</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-26T22:45:19+08:00">
                2015-11-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/11/14/Linux常用命令之top/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/14/Linux常用命令之top/" itemprop="url">Linux常用命令之top</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-14T16:32:40+08:00">
                2015-11-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>top是linux下常用的性能分析工具，能够实时显示系统中各个进程的资源占用状况，.该命令可以按CPU使用.内存使用和执行时间对任务进行排序，而且该命令的很多特性都可以通过交互式命令或者在个人定制文件中进行设定<br>下面分几个部分介绍一下这个命令：  </p>
<ol>
<li>命令相关参数介绍。</li>
<li>常用命令示例。</li>
</ol>
<h1 id="命令相关参数介绍"><a href="#命令相关参数介绍" class="headerlink" title="命令相关参数介绍"></a>命令相关参数介绍</h1><p>在命令行执行top命令显示如下：<br><img src="/2015/11/14/Linux常用命令之top/top命令-1.png" alt="[top命令示例]" title="[top命令示例]">  </p>
<h2 id="统计信息区前五行是系统整体的统计信息。"><a href="#统计信息区前五行是系统整体的统计信息。" class="headerlink" title="统计信息区前五行是系统整体的统计信息。"></a>统计信息区前五行是系统整体的统计信息。</h2><h3 id="第一行是任务队列信息-其内容如下："><a href="#第一行是任务队列信息-其内容如下：" class="headerlink" title="第一行是任务队列信息,其内容如下："></a>第一行是任务队列信息,其内容如下：</h3><blockquote>
<p>top - 15:55:44 up 58 days, 21:49,  1 user,  load average: 0.00, 0.05, 0.07</p>
</blockquote>
<p>其中<code>15:55:44</code>表示当前时间；<code>up 58 days, 21:49</code> 表示系统已经连续运行了58天21小时49分钟; <code>1 user</code> 表示当前登录的用户数; <code>load average: 0.00, 0.05, 0.07</code> 表示系统负载，也即任务队列的平均长度，三个数值分别代表过去1分钟、5分钟以及15分钟的系统平均负载，如果这个数除以逻辑CPU的数量，结果高于5的时候就表明系统在超负荷运转了。  </p>
<h3 id="第二行是任务（进程）信息，其内容为："><a href="#第二行是任务（进程）信息，其内容为：" class="headerlink" title="第二行是任务（进程）信息，其内容为："></a>第二行是任务（进程）信息，其内容为：</h3><blockquote>
<p>Tasks: 197 total,   1 running, 196 sleeping,   0 stopped,   0 zombie</p>
</blockquote>
<p>这一行表示系统现在共有197个进程，其中处于运行中的有1个，196个在休眠（sleep），stopped状态的有0个，zombie（僵尸）状态的有0个  </p>
<h3 id="第三行是CPU信息："><a href="#第三行是CPU信息：" class="headerlink" title="第三行是CPU信息："></a>第三行是CPU信息：</h3><blockquote>
<p>Cpu(s):  9.6%us,  0.7%sy,  0.0%ni, 89.6%id,  0.0%wa,  0.0%hi,  0.1%si,  0.0%st</p>
</blockquote>
<p><code>9.6%us</code> 表示用户空间占用CPU的百分比为9.6%；<code>0.7%sy</code> 表示内核空间占用CPU的百分比为0.7%；<code>0.0%ni</code> 表示改变过优先级的进程占用CPU的百分比为0；<code>89.6%id</code> 表示空闲CPU的百分比为89.6%; <code>0.0%wa</code> 表示IO等待占用CPU的百分比为0；<code>0.0%hi</code> 表示硬中断（Hardware Interrupts）占用CPU的百分比为0；<code>0.1%si</code> 表示软中断（Software Interrupts）占用CPU的百分比为0.1%；<code>0.0%st</code> 表示虚拟机占用CPU的百分比为0。  </p>
<h3 id="第四行是内存信息："><a href="#第四行是内存信息：" class="headerlink" title="第四行是内存信息："></a>第四行是内存信息：</h3><blockquote>
<p>Mem:  32850724k total, 32569108k used,   281616k free,   491520k buffers</p>
</blockquote>
<p><code>32850724k total</code> 表示总物理内存为32G；<code>32569108k used</code> 表示已经使用的物理内存大小为将近32G；<code>281616k free</code> 表示当前空闲的物理内存大小为270多M；<code>491520k buffers</code> 表示用作内核缓存的内存大小约为480M；  </p>
<h3 id="第五行是swap交换分区信息："><a href="#第五行是swap交换分区信息：" class="headerlink" title="第五行是swap交换分区信息："></a>第五行是swap交换分区信息：</h3><blockquote>
<p>Swap: 12582904k total,        0k used, 12582904k free, 20604232k cached</p>
</blockquote>
<p><code>12582904k total</code> 表示交换区总量为12G；<code>0k used</code> 表示当前已经使用的交换区大小为0；<code>12582904k free</code> 表示空闲的交换区总量为12G；<code>20604232k cached</code> 表示缓冲的交换区总量,内存中的内容被换出到交换区，而后又被换入到内存，但使用过的交换区尚未被覆盖，该数值即为这些内容已存在于内存中的交换区的大小,相应的内存再次被换出时可不必再对交换区写入。 </p>
<p>这里要说明一下，第四行中使用中的内存总量（used）指的是现在系统内核控制的内存数，空闲内存总量（free）是内核还未纳入其管控范围的数量。纳入内核管理的内存不见得都在使用中，还包括过去使用过的现在可以被重复利用的内存，内核并不把这些可被重新使用的内存交还到free中去，因此在linux上free内存会越来越少，但不用为此担心。<br>如果出于习惯去计算可用内存数，这里有个近似的计算公式：第四行的free + 第四行的buffers + 第五行的cached，按这个公式此台服务器的可用内存：281616k+491520k+20604232k = 20GB左右。<br>对于内存监控，在top里我们要时刻监控第五行swap交换分区的used，如果这个数值在不断的变化，说明内核在不断进行内存和swap的数据交换，这是真正的内存不够用了。  </p>
<h2 id="5行之后列出的是详细的进程统计信息，top命令提供的统计信息包含："><a href="#5行之后列出的是详细的进程统计信息，top命令提供的统计信息包含：" class="headerlink" title="5行之后列出的是详细的进程统计信息，top命令提供的统计信息包含："></a>5行之后列出的是详细的进程统计信息，top命令提供的统计信息包含：</h2><table>
<thead>
<tr>
<th>序号</th>
<th>列名</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>PID</td>
<td>进程id</td>
</tr>
<tr>
<td>b</td>
<td>PPID</td>
<td>父进程ID</td>
</tr>
<tr>
<td>c</td>
<td>RUSER</td>
<td>Real user name</td>
</tr>
<tr>
<td>d</td>
<td>UID</td>
<td>进程所有者的用户ID</td>
</tr>
<tr>
<td>e</td>
<td>USER</td>
<td>进程所有者的用户名</td>
</tr>
<tr>
<td>f</td>
<td>GROUP</td>
<td>进程所有者的组名</td>
</tr>
<tr>
<td>g</td>
<td>TTY</td>
<td>启动进程的终端名，不是从终端启动的进程显示为？</td>
</tr>
<tr>
<td>h</td>
<td>PR</td>
<td>进程优先级</td>
</tr>
<tr>
<td>i</td>
<td>NI</td>
<td>进程nice值。负值表示高优先级，正值表示低优先级，值越小代表优先级越高。</td>
</tr>
<tr>
<td>j</td>
<td>P</td>
<td>最后使用的CPU，仅在多CPU环境下有意义</td>
</tr>
<tr>
<td>k</td>
<td>%CPU</td>
<td>上次更新到现在的CPU时间占用百分比</td>
</tr>
<tr>
<td>l</td>
<td>TIME</td>
<td>进程使用的CPU时间总计，单位秒</td>
</tr>
<tr>
<td>m</td>
<td>TIME+</td>
<td>进程使用的CPU时间总计，单位1/100秒</td>
</tr>
<tr>
<td>n</td>
<td>%MEM</td>
<td>进程使用的物理内存百分比</td>
</tr>
<tr>
<td>o</td>
<td>VIRT</td>
<td>进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES</td>
</tr>
<tr>
<td>p</td>
<td>SWAP</td>
<td>进程使用的虚拟内存中，被换出的大小，单位kb。</td>
</tr>
<tr>
<td>q</td>
<td>RES</td>
<td>进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA</td>
</tr>
<tr>
<td>r</td>
<td>CODE</td>
<td>可执行代码占用的物理内存大小，单位kb</td>
</tr>
<tr>
<td>s</td>
<td>DATA</td>
<td>可执行代码以外的部分(数据段+栈)占用的物理内存大小，单位kb</td>
</tr>
<tr>
<td>t</td>
<td>SHR</td>
<td>共享内存大小，单位kb</td>
</tr>
<tr>
<td>u</td>
<td>nFLT</td>
<td>页面错误次数</td>
</tr>
<tr>
<td>v</td>
<td>nDRT</td>
<td>最后一次写入到现在，被修改过的页面数。</td>
</tr>
<tr>
<td>w</td>
<td>S</td>
<td>进程状态(D=不可中断的睡眠状态,R=运行,S=睡眠,T=跟踪/停止,Z=僵尸进程)</td>
</tr>
<tr>
<td>x</td>
<td>COMMAND</td>
<td>进程启动的命令行</td>
</tr>
<tr>
<td>y</td>
<td>WCHAN</td>
<td>若该进程在睡眠，则显示睡眠中的系统函数名</td>
</tr>
<tr>
<td>z</td>
<td>Flags</td>
<td>任务标志，参考 sched.h</td>
</tr>
</tbody>
</table>
<p>示例中目前列出来的主要有：</p>
<blockquote>
<p>PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND</p>
</blockquote>
<ul>
<li>如果想更改显示出来的内容, 可以按 f 键进入选择显示的内容视图。按 f 键之后会显示列的列表，按 a-z 即可显示或隐藏对应的列，当前显示的列会用*号以及大写序号标识，没有显示的用小写标识，选择完成后按回车键确定。示例如下：  </li>
</ul>
<img src="/2015/11/14/Linux常用命令之top/top命令-2.png" alt="[top命令示例]" title="[top命令示例]">
<ul>
<li>如果想要更改显示的列的顺序，可以按 o 键进入调整显示列顺序的视图。在该视图中可以按小写的 a-z 可以将相应的列向右移动，而大写的 A-Z 可以将相应的列向左移动。最后按回车键确定。 示例如下：  </li>
</ul>
<img src="/2015/11/14/Linux常用命令之top/top命令-3.png" alt="[top命令示例]" title="[top命令示例]">  
<ul>
<li>如果想要更改排序的列（默认是%CPU), 可以按大写的 F 或 O 键，然后按 a-z 可以将进程按照相应的列进行排序。而大写的 R 键可以将当前的排序倒转。示例如下：</li>
</ul>
<img src="/2015/11/14/Linux常用命令之top/top命令-4.png" alt="[top命令示例]" title="[top命令示例]">  
<h1 id="top交互命令"><a href="#top交互命令" class="headerlink" title="top交互命令"></a>top交互命令</h1><p>top交互命令总结如下：  </p>
<table>
<thead>
<tr>
<th>交互命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>h或?</td>
<td>显示帮助画面，给出一些简短的命令总结说明</td>
</tr>
<tr>
<td>Z</td>
<td>修改Summary/Messages or Prompts/Column Heads/Task Information的显示颜色</td>
</tr>
<tr>
<td>z</td>
<td>分颜色显示on/off</td>
</tr>
<tr>
<td>B</td>
<td>打开或者关闭Bold显示模式（summary信息以及正在运行的Task）</td>
</tr>
<tr>
<td>b</td>
<td>只有当x或者y正在使用的时候有效，取消／显示高亮</td>
</tr>
<tr>
<td>x</td>
<td>高亮当前正在排序的列（on/off)</td>
</tr>
<tr>
<td>y</td>
<td>高亮当前正在运行的Task (on/off)</td>
</tr>
<tr>
<td>l</td>
<td>显示／隐藏load信息</td>
</tr>
<tr>
<td>t</td>
<td>显示／隐藏task/cpu的信息</td>
</tr>
<tr>
<td>m</td>
<td>显示／隐藏mem的信息</td>
</tr>
<tr>
<td>1</td>
<td>显示／隐藏每个CPU的详细信息</td>
</tr>
<tr>
<td>I</td>
<td>打开／关闭Irix/Solaris模式</td>
</tr>
<tr>
<td>f</td>
<td>增加／减少显示的列</td>
</tr>
<tr>
<td>o</td>
<td>更改列显示的顺序</td>
</tr>
<tr>
<td>F/O</td>
<td>更改排序的列</td>
</tr>
<tr>
<td>&gt;</td>
<td>向右更改排序的列</td>
</tr>
<tr>
<td>&lt;</td>
<td>向左更改排序的列</td>
</tr>
<tr>
<td>R</td>
<td>顺序／逆序显示</td>
</tr>
<tr>
<td>H</td>
<td>显示具体的线程信息</td>
</tr>
<tr>
<td>c</td>
<td>显示／隐藏程序启动命令</td>
</tr>
<tr>
<td>i</td>
<td>显示／隐藏idle的Task（进程）</td>
</tr>
<tr>
<td>S</td>
<td>打开／关闭cumulative time</td>
</tr>
<tr>
<td>u</td>
<td>输入某个用户名可以只显示属于该用户的进程</td>
</tr>
<tr>
<td>n/#</td>
<td>设置最多显示的进程的数目</td>
</tr>
<tr>
<td>k</td>
<td>输入进程ID杀掉该进程</td>
</tr>
<tr>
<td>r</td>
<td>输入进程ID重新设置该进程的nice值</td>
</tr>
<tr>
<td>d/s</td>
<td>设置刷新时间</td>
</tr>
<tr>
<td>W</td>
<td>将更改后的配置保存到本地~/.toprc文件中</td>
</tr>
<tr>
<td>q</td>
<td>退出</td>
</tr>
</tbody>
</table>
<img src="/2015/11/14/Linux常用命令之top/top命令-5.png" alt="[top命令示例]" title="[top命令示例]">
<h1 id="常用命令示例"><a href="#常用命令示例" class="headerlink" title="常用命令示例"></a>常用命令示例</h1><h2 id="多核CPU监控-按1）"><a href="#多核CPU监控-按1）" class="headerlink" title="多核CPU监控(按1）"></a>多核CPU监控(按1）</h2><img src="/2015/11/14/Linux常用命令之top/top命令-6.png" alt="[top命令示例]" title="[top命令示例]">
<h2 id="高亮当前正在运行的进程-按y，如果没有高亮，接着按b"><a href="#高亮当前正在运行的进程-按y，如果没有高亮，接着按b" class="headerlink" title="高亮当前正在运行的进程(按y，如果没有高亮，接着按b)"></a>高亮当前正在运行的进程(按y，如果没有高亮，接着按b)</h2><img src="/2015/11/14/Linux常用命令之top/top命令-8.png" alt="[top命令示例]" title="[top命令示例]">
<h2 id="高亮当前用于排序的列-按x，如果没有高亮，接着按b）"><a href="#高亮当前用于排序的列-按x，如果没有高亮，接着按b）" class="headerlink" title="高亮当前用于排序的列(按x，如果没有高亮，接着按b）"></a>高亮当前用于排序的列(按x，如果没有高亮，接着按b）</h2><img src="/2015/11/14/Linux常用命令之top/top命令-7.png" alt="[top命令示例]" title="[top命令示例]">
<h2 id="通过”shift-gt-”或”shift-lt-”可以向右或左改变排序列"><a href="#通过”shift-gt-”或”shift-lt-”可以向右或左改变排序列" class="headerlink" title="通过”shift + &gt;”或”shift + &lt;”可以向右或左改变排序列"></a>通过”shift + &gt;”或”shift + &lt;”可以向右或左改变排序列</h2><img src="/2015/11/14/Linux常用命令之top/top命令-9.png" alt="[top命令示例]" title="[top命令示例]">
<h2 id="显示进程启动命令（按c）"><a href="#显示进程启动命令（按c）" class="headerlink" title="显示进程启动命令（按c）"></a>显示进程启动命令（按c）</h2><img src="/2015/11/14/Linux常用命令之top/top命令-10.png" alt="[top命令示例]" title="[top命令示例]">
<h2 id="只显示某个进程（top-p"><a href="#只显示某个进程（top-p" class="headerlink" title="只显示某个进程（top -p )"></a>只显示某个进程（top -p <pid>)</pid></h2><img src="/2015/11/14/Linux常用命令之top/top命令-11.png" alt="[top命令示例]" title="[top命令示例]">

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/11/01/Android应用程序签名/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/11/01/Android应用程序签名/" itemprop="url">Android应用程序签名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-01T16:00:48+08:00">
                2015-11-01
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近工作中需要封装一个客户端的sdk包，写了一个简单的示例程序，准备安装到手机的时候提示程序没有签名，安装失败，特查了一下android包的签名方式，在此记录一下，以备后用。  </p>
<h1 id="签名的意义"><a href="#签名的意义" class="headerlink" title="签名的意义"></a>签名的意义</h1><p>为了保证每个应用程序开发商合法ID，防止部分开放商可能通过使用相同的Package Name来混淆替换已经安装的程序，我们需要对我们发布的APK文件进行唯一签名，保证我们每次发布的版本的一致性(如自动更新不会因为版本不一致而无法安装)。</p>
<h1 id="APK签名步骤"><a href="#APK签名步骤" class="headerlink" title="APK签名步骤"></a>APK签名步骤</h1><ol>
<li>生成keystore</li>
<li>用jarsigner签名apk</li>
<li>zipalign对齐优化apk文件（可选）<br>下面分别介绍一下这三部分。 </li>
</ol>
<h1 id="生成keystore"><a href="#生成keystore" class="headerlink" title="生成keystore"></a>生成keystore</h1><p>这一步需要使用keytool这个工具，这个工具是跟随JDK一起安装的，所以只要安装完java设置好路径后一般都是可以直接在命令行使用的。打开命令行，执行下面命令：</p>
<blockquote>
<p>keytool -genkey -alias abc.keystore -keyalg RSA -validity 20000 -keystore abc.keystore  </p>
</blockquote>
<ul>
<li>-genkey 产生密钥  </li>
<li>-alias abc.keystore 别名 abc.keystore  (abc只是示例所用的名字，可以根据需要自己重新命名的）  </li>
<li>-keyalg RSA 使用RSA算法对签名加密  </li>
<li>-validity 20000 有效期限20000天  </li>
<li>-keystore abc.keystore  （一般要跟alias保持一致）<br>执行完这个命令后会要求输入一堆信息，示例如下：    
执行成功的话会在当前目录下看到生成的abc.keystore文件  </li>
</ul>
<h1 id="用jarsigner签名apk"><a href="#用jarsigner签名apk" class="headerlink" title="用jarsigner签名apk"></a>用jarsigner签名apk</h1><p>jarsigner这个tool也是跟随JDK一起安装的，命令行可以直接使用。命令如下:<br>&lt; jarsigner -verbose -keystore abc.keystore -signedjar demo_signed.apk demo.apk abc.keystore  </p>
<ul>
<li>-verbose 输出签名的详细信息</li>
<li>-keystore  abc.keystore 密钥库位置</li>
<li>-signedjar demo_signed.apk demo.apk abc.keystore 正式签名，三个参数中依次为签名后产生的文件demo_signed，要签名的文件demo.apk和密钥库abc.keystore.<br>提示输入密码的时候记得输入生成keystore文件时设置的密码  </li>
</ul>
<h1 id="zipalign优化生成的apk文件"><a href="#zipalign优化生成的apk文件" class="headerlink" title="zipalign优化生成的apk文件"></a>zipalign优化生成的apk文件</h1><p>未签名的apk不能使用，也不能优化。签名之后的apk谷歌推荐使用zipalign.exe(位于下载的android-sdk包中)工具对其优化，命令如下：  </p>
<blockquote>
<p>zipalign -v 4 demo_signed.apk final.apk  </p>
</blockquote>
<p>zipalign能够使apk文件中未压缩的数据在4个字节边界上对齐（4个字节是一个性能很好的值），这样android系统就可以使用mmap()(请自行查阅这个函数的用途)函数读取文件，可以在读取资源上获得较高的性能，在4个字节边界上对齐的意思就是，一般来说，是指编译器吧4个字节作为一个单位来进行读取的结果，这样的话，CPU能够对变量进行高效、快速的访问（较之前不对齐）。对齐的根源是android系统中的Davlik虚拟机使用自己专有的格式DEX，DEX的结构是紧凑的，为了让运行时的性能更好，可以进一步用”对齐”进一步优化，但是大小一般会有所增加。  </p>
<p>经过以上三个步骤，最终生成的final.apk文件就可以通过adb install成功安装到手机上了。</p>
<h1 id="签名对APP的影响"><a href="#签名对APP的影响" class="headerlink" title="签名对APP的影响"></a>签名对APP的影响</h1><p>你不可能只做一个APP，你可能有一个宏伟的战略工程，想要在生活，服务，游戏，系统各个领域都想插足的话，你不可能只做一个APP，谷歌建议你把你所有的APP都使用同一个签名证书。<br>使用你自己的同一个签名证书，就没有人能够覆盖你的应用程序，即使包名相同，所以影响有:  </p>
<ol>
<li>App升级。 使用相同签名的升级软件可以正常覆盖老版本的软件，否则系统比较发现新版本的签名证书和老版本的签名证书不一致，不会允许新版本安装成功的。</li>
<li>App模块化。android系统允许具有相同的App运行在同一个进程中，如果运行在同一个进程中，则他们相当于同一个App，但是你可以单独对他们升级更新，这是一种App级别的模块化思路。</li>
<li>允许代码和数据共享。android中提供了一个基于签名的Permission标签。通过允许的设置，我们可以实现对不同App之间的访问和共享，如下：<blockquote>
<p>AndroidManifest.xml：&lt;permission android:protectionLevel=”normal” /&gt;</p>
</blockquote>
</li>
</ol>
<p>其中protectionLevel标签有4种值：normal(缺省值),dangerous, signature,signatureOrSystem。简单来说，normal是低风险的，所有的App不能访问和共享此App。dangerous是高风险的，所有的App都能访问和共享此App。signature是指具有相同签名的App可以访问和共享此App。signatureOrSystem是指系统image中App和具有相同签名的App可以访问和共享此App，谷歌建议不要使用这个选项，因为签名就足够了，一般这个许可会被用在在一个image中需要共享一些特定的功能的情况下。</p>
<p>最后，请一定要记得保管好你的签名证书的密码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/10/30/常用负载均衡算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/30/常用负载均衡算法/" itemprop="url">常用负载均衡算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-30T08:38:29+08:00">
                2015-10-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近调查一个线上问题，发现问题跟负载均衡算法有关系，特意了解了目前常用的几种算法，总结如下：  </p>
<ol>
<li><p>随机：负载均衡方法随机的把负载分配到各个可用的服务器上，通过随机数生成算法选取一个服务器，然后把连接发送给它。虽然许多均衡产品都支持该算法，但是它的有效性一直受到质疑，除非把服务器的可运行时间看的很重。</p>
</li>
<li><p>轮询：轮询算法按顺序把每个新的连接请求分配给下一个服务器，最终把所有请求平分给所有的服务器。轮询算法在大多数情况下都工作的不错，但是如果负载均衡的设备在处理速度、连接速度和内存等方面不是完全均等，那么效果会更好。</p>
</li>
<li><p>加权轮询：该算法中，每个机器接受的连接数量是按权重比例分配的。这是对普通轮询算法的改进，比如你可以设定：第三台机器的处理能力是第一台机器的两倍，那么负载均衡器会把两倍的连接数量分配给第3台机器。</p>
</li>
<li><p>动态轮询：类似于加权轮询，但是，权重值基于对各个服务器的持续监控，并且不断更新。这是一个动态负载均衡算法，基于服务器的实时性能分析分配连接，比如每个节点的当前连接数或者节点的最快响应时间等。</p>
</li>
<li><p>最快算法：最快算法基于所有服务器中的最快响应时间分配连接。该算法在服务器跨不同网络的环境中特别有用。</p>
</li>
<li><p>最少连接：系统把新连接分配给当前连接数目最少的服务器。该算法在各个服务器运算能力基本相似的环境中非常有效。</p>
</li>
<li><p>观察算法：该算法同时利用最小连接算法和最快算法来实施负载均衡。服务器根据当前的连接数和响应时间得到一个分数，分数较高代表性能较好，会得到更多的连接。</p>
</li>
<li><p>预判算法：该算法使用观察算法来计算分数，但是预判算法会分析分数的变化趋势来判断某台服务器的性能正在改善还是降低。具有改善趋势的服务器会得到更多的连接。该算法适用于大多数环境。</p>
</li>
</ol>
<p>references: <a href="https://devcentral.f5.com/articles/intro-to-load-balancing-for-developers-ndash-the-algorithms" target="_blank" rel="external">introduction to load balancing</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/10/25/GC学习资料收集/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/25/GC学习资料收集/" itemprop="url">GC学习资料收集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-25T23:32:02+08:00">
                2015-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="学习资料收集"><a href="#学习资料收集" class="headerlink" title="学习资料收集"></a>学习资料收集</h1><ol>
<li><a href="http://blog.csdn.net/china_wanglong/article/details/38816575" target="_blank" rel="external">垃圾收集器介绍</a>  </li>
<li><a href="http://blog.csdn.net/fenglibing/article/details/6321453" target="_blank" rel="external">GC学习笔记</a>  </li>
<li><a href="http://itindex.net/detail/47030-cms-gc-%E9%97%AE%E9%A2%98" target="_blank" rel="external">一次CMS GC问题排查过程（理解原理+读懂GC日志)</a>  </li>
<li><a href="http://www.tuicool.com/articles/jq2yIza" target="_blank" rel="external">深入理解Major GC, Full GC, CMS</a>  </li>
<li><a href="http://ifeve.com/jvm-cms-log/" target="_blank" rel="external">了解 CMS 垃圾回收日志</a>  </li>
<li><a href="http://www.importnew.com/3146.html" target="_blank" rel="external">成为Java GC专家（3）—如何优化Java垃圾回收机制</a>  </li>
<li><a href="http://www.cnblogs.com/redcreen/archive/2011/05/04/2037057.html" target="_blank" rel="external">JVM参数设置以及分析</a>  </li>
<li><a href="http://blog.csdn.net/xinwang/article/details/11720845" target="_blank" rel="external">触发Full GC执行的情况</a>  </li>
<li><a href="http://ju.outofmemory.cn/entry/46215" target="_blank" rel="external">一次非常诡异的CMS GC频繁问题的排查</a>  </li>
<li><a href="http://iamzhongyong.iteye.com/blog/1333100" target="_blank" rel="external">java内存区域理解-初步了解</a>  </li>
<li><a href="http://blog.csdn.net/fenglibing/article/details/6411940" target="_blank" rel="external">jstack命令使用</a>  </li>
<li><a href="http://blog.csdn.net/fenglibing/article/details/6411951" target="_blank" rel="external">jstat命令使用</a>  </li>
<li><a href="http://blog.csdn.net/gtuu0123/article/details/6039474" target="_blank" rel="external">jhat命令使用</a>  </li>
<li><a href="http://my.oschina.net/goldwave/blog/168516" target="_blank" rel="external">关于施用full gc频繁的分析及解决</a>  </li>
<li><a href="http://www.cnblogs.com/ggjucheng/p/3977612.html" target="_blank" rel="external">JVM GC算法CMS详解</a>   </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.wxpjimmy.com/2015/10/25/ImageDemo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wxpjimmy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jimmy's Harbor">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/10/25/ImageDemo/" itemprop="url">ImageDemo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-25T22:52:57+08:00">
                2015-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>测试一下插入本地图片<br><img src="/2015/10/25/ImageDemo/serial_young_gc.gif" alt="[serial young gc]" title="[serial young gc]"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/3627160?s=460&v=4"
                alt="wxpjimmy" />
            
              <p class="site-author-name" itemprop="name">wxpjimmy</p>
              <p class="site-description motion-element" itemprop="description">Be a better man!</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          <div class="links-of-author motion-element">
            
              
                <span class="links-of-author-item">
                  <a href="https://github.com/wxpjimmy" target="_blank" title="GitHub">
                    
                      <i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:wxpjimmy@gmail.com" target="_blank" title="E-Mail">
                    
                      <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wxpjimmy</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  








  












  





  

  

  
  

  

  

  

</body>
</html>
